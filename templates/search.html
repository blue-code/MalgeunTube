{% extends 'base.html' %}

{% block title %}{{ query }} - ê²€ìƒ‰ ê²°ê³¼{% endblock %}

{% block content %}
<div class="search-container">
    {% if query %}
    <h2>"{{ query }}" ê²€ìƒ‰ ê²°ê³¼</h2>
    
    {% if results.error %}
    <div class="error-message">
        <p>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {{ results.error }}</p>
    </div>
    {% elif results %}
    <div class="search-results">
        {% for video in results %}
        <div class="search-item">
            <a href="{{ url_for('watch', v=video.id) }}" class="search-link">
                <div class="thumbnail">
                    <img src="{{ video.thumbnail }}" alt="{{ video.title }}" loading="lazy">
                    {% if video.duration %}
                    <span class="duration">{{ video.duration|duration }}</span>
                    {% endif %}
                </div>
                <div class="search-info">
                    <h3>{{ video.title }}</h3>
                    <p class="channel">{{ video.channel }}</p>
                    {% if video.view_count %}
                    <p class="views">ì¡°íšŒìˆ˜ {{ video.view_count|views }}íšŒ</p>
                    {% endif %}
                </div>
            </a>
            <div class="search-actions">
                {% if video.channel_id %}
                <button class="action-btn subscribe-btn {% if video.is_subscribed %}subscribed{% endif %}" 
                        onclick="toggleSubscribe(this, '{{ video.channel_id }}', '{{ video.channel|e }}')"
                        title="{% if video.is_subscribed %}êµ¬ë… ì·¨ì†Œ{% else %}êµ¬ë…{% endif %}">
                    {% if video.is_subscribed %}â˜…{% else %}â˜†{% endif %}
                </button>
                {% endif %}
                <button class="action-btn" 
                        onclick="openPlaylistModal(this)"
                        data-id="{{ video.id }}"
                        data-title="{{ video.title|e }}"
                        data-thumbnail="{{ video.thumbnail }}"
                        data-duration="{{ video.duration or 0 }}"
                        data-channel="{{ video.channel|e }}"
                        title="í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€">
                    â•
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-results">
        <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
    
    {% else %}
    <div class="search-placeholder">
        <div class="empty-icon">ğŸ”</div>
        <h3>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
    </div>
    {% endif %}
</div>

<!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
<div id="playlist-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</h3>
            <button class="modal-close" onclick="closePlaylistModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="playlist-list">
                {% if user_playlists %}
                    {% for pl in user_playlists %}
                    <button class="playlist-option" onclick="addToPlaylist('{{ pl.id }}')">
                        ğŸ“ {{ pl.name }} ({{ pl.videos|length }}ê°œ)
                    </button>
                    {% endfor %}
                {% else %}
                    <p style="color:var(--text-secondary); text-align:center; padding:1rem;">ìƒì„±ëœ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            <div class="create-playlist">
                <input type="text" id="new-playlist-name" placeholder="ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„">
                <button onclick="createAndAddPlaylist()" class="btn">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentVideoData = null;

function openPlaylistModal(btn) {
    currentVideoData = {
        id: btn.dataset.id,
        title: btn.dataset.title,
        thumbnail: btn.dataset.thumbnail,
        duration: parseFloat(btn.dataset.duration),
        channel: btn.dataset.channel
    };
    document.getElementById('playlist-modal').classList.add('show');
    document.getElementById('new-playlist-name').value = '';
}

function closePlaylistModal() {
    document.getElementById('playlist-modal').classList.remove('show');
    currentVideoData = null;
}

async function addToPlaylist(playlistId) {
    if (!currentVideoData) return;
    
    try {
        const response = await fetch('/api/playlist/' + playlistId + '/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(currentVideoData)
        });
        
        if (response.ok) {
            showToast('ì¶”ê°€ ì™„ë£Œ');
            closePlaylistModal();
        } else {
            showToast('ì´ë¯¸ ì¶”ê°€ë¨');
        }
    } catch (e) {
        showToast('ì˜¤ë¥˜ ë°œìƒ');
    }
}

async function createAndAddPlaylist() {
    if (!currentVideoData) return;
    
    const nameInput = document.getElementById('new-playlist-name');
    const name = nameInput.value.trim();
    if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }
    
    try {
        const response = await fetch('/api/playlist/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        });
        
        const data = await response.json();
        if (data.playlist_id) {
            await addToPlaylist(data.playlist_id);
            location.reload(); // ëª©ë¡ ê°±ì‹ ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
        }
    } catch (e) {
        showToast('ìƒì„± ì‹¤íŒ¨');
    }
}

async function toggleSubscribe(btn, channelId, channelName) {
    const isSubscribed = btn.classList.contains('subscribed');
    const channelUrl = `https://www.youtube.com/channel/${channelId}`;
    
    try {
        const endpoint = isSubscribed ? '/api/channel/unsubscribe' : '/api/channel/subscribe';
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                channel_id: channelId,
                name: channelName,
                channel_url: channelUrl
            })
        });
        
        if (response.ok) {
            btn.classList.toggle('subscribed');
            btn.innerHTML = isSubscribed ? 'â˜†' : 'â˜…';
            btn.title = isSubscribed ? 'êµ¬ë…' : 'êµ¬ë… ì·¨ì†Œ';
            showToast(isSubscribed ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€');
        }
    } catch (e) {
        showToast('ìš”ì²­ ì‹¤íŒ¨');
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
document.getElementById('playlist-modal').addEventListener('click', function(e) {
    if (e.target === this) closePlaylistModal();
});

document.getElementById('new-playlist-name').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') createAndAddPlaylist();
});
</script>

<style>
.no-results, .search-placeholder {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.subscribe-btn {
    color: var(--text-secondary);
    font-size: 1.2rem;
}

.subscribe-btn.subscribed {
    color: #ffd700; /* Gold color for star */
}

.subscribe-btn:hover {
    color: var(--text-primary);
}

.subscribe-btn.subscribed:hover {
    color: #ffed4a;
}
</style>
{% endblock %}