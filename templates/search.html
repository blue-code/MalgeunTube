{% extends 'base.html' %}

{% block title %}{{ query }} - ê²€ìƒ‰ ê²°ê³¼{% endblock %}

{% block content %}
<div class="search-container">
    {% if query %}
    <div class="search-header">
        <h2>"{{ query }}" ê²€ìƒ‰ ê²°ê³¼</h2>
        <button id="filter-toggle-btn" class="btn btn-filter" onclick="toggleFilters()">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
            </svg>
            í•„í„°
        </button>
    </div>

    <!-- ê³ ê¸‰ í•„í„° -->
    <div id="search-filters" class="search-filters">
        <div class="filter-group">
            <label>ê¸¸ì´</label>
            <select id="filter-duration" onchange="applyFilters()">
                <option value="">ì „ì²´</option>
                <option value="short">1ë¶„ ë¯¸ë§Œ</option>
                <option value="medium">5-20ë¶„</option>
                <option value="long">20ë¶„ ì´ìƒ</option>
            </select>
        </div>

        <div class="filter-group">
            <label>ì—…ë¡œë“œ ë‚ ì§œ</label>
            <select id="filter-upload-date" onchange="applyFilters()">
                <option value="">ì „ì²´</option>
                <option value="today">ì˜¤ëŠ˜</option>
                <option value="week">ì´ë²ˆ ì£¼</option>
                <option value="month">ì´ë²ˆ ë‹¬</option>
                <option value="year">ì˜¬í•´</option>
            </select>
        </div>

        <div class="filter-group">
            <label>ì •ë ¬</label>
            <select id="filter-sort" onchange="applyFilters()">
                <option value="relevance">ê´€ë ¨ì„±</option>
                <option value="views">ì¡°íšŒìˆ˜ ë†’ì€ìˆœ</option>
                <option value="date">ìµœì‹ ìˆœ</option>
            </select>
        </div>

        <div class="filter-group">
            <label>ì±„ë„</label>
            <select id="filter-channel" onchange="applyFilters()">
                <option value="">ì „ì²´ ì±„ë„</option>
                <option value="subscribed">êµ¬ë…í•œ ì±„ë„ë§Œ</option>
            </select>
        </div>

        <button class="btn btn-reset" onclick="resetFilters()">ì´ˆê¸°í™”</button>
    </div>

    {% if results.error %}
    <div class="error-message">
        <p>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {{ results.error }}</p>
    </div>
    {% elif results %}
    <div class="search-results-header">
        <p id="result-count">ê²€ìƒ‰ ê²°ê³¼ <span id="count-number">{{ results|length }}</span>ê°œ <span id="filtered-count"></span></p>
    </div>
    <div class="search-results" id="search-results">
        {% for video in results %}
        <div class="search-item">
            <a href="{{ url_for('watch', v=video.id) }}" class="search-link">
                <div class="thumbnail">
                    <img src="{{ video.thumbnail }}" alt="{{ video.title }}" loading="lazy">
                    {% if video.duration %}
                    <span class="duration">{{ video.duration|duration }}</span>
                    {% endif %}
                </div>
                <div class="search-info">
                    <h3>{{ video.title }}</h3>
                    <p class="channel">{{ video.channel }}</p>
                    {% if video.view_count %}
                    <p class="views">ì¡°íšŒìˆ˜ {{ video.view_count|views }}íšŒ</p>
                    {% endif %}
                </div>
            </a>
            <div class="search-actions">
                {% if video.channel_id %}
                <button class="action-btn subscribe-btn {% if video.is_subscribed %}subscribed{% endif %}" 
                        onclick="toggleSubscribe(this, '{{ video.channel_id }}', '{{ video.channel|e }}')"
                        title="{% if video.is_subscribed %}êµ¬ë… ì·¨ì†Œ{% else %}êµ¬ë…{% endif %}">
                    {% if video.is_subscribed %}â˜…{% else %}â˜†{% endif %}
                </button>
                {% endif %}
                <button class="action-btn" 
                        onclick="openPlaylistModal(this)"
                        data-id="{{ video.id }}"
                        data-title="{{ video.title|e }}"
                        data-thumbnail="{{ video.thumbnail }}"
                        data-duration="{{ video.duration or 0 }}"
                        data-channel="{{ video.channel|e }}"
                        title="í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€">
                    â•
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if results|length >= 20 %}
    <div id="load-more-container" style="text-align: center; margin-top: 2rem;">
        <button id="load-more-btn" class="btn">
            ë” ë§ì€ ê²°ê³¼ ë³´ê¸°
        </button>
        <div id="loading-spinner" style="display: none; padding: 2rem;">
            <div class="spinner"></div>
            <p>ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        <p id="no-more-results" style="display: none; color: var(--text-secondary); padding: 1rem;">
            ë” ì´ìƒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤
        </p>
    </div>
    {% endif %}

    {% else %}
    <div class="no-results">
        <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}

    {% else %}
    <div class="search-placeholder">
        <div class="empty-icon">ğŸ”</div>
        <h3>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
    </div>
    {% endif %}
</div>

<!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
<div id="playlist-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</h3>
            <button class="modal-close" onclick="closePlaylistModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="playlist-list">
                {% if user_playlists %}
                    {% for pl in user_playlists %}
                    <button class="playlist-option" onclick="addToPlaylist('{{ pl.id }}')">
                        ğŸ“ {{ pl.name }} ({{ pl.videos|length }}ê°œ)
                    </button>
                    {% endfor %}
                {% else %}
                    <p style="color:var(--text-secondary); text-align:center; padding:1rem;">ìƒì„±ëœ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
            <div class="create-playlist">
                <input type="text" id="new-playlist-name" placeholder="ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„">
                <button onclick="createAndAddPlaylist()" class="btn">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentVideoData = null;
let allVideos = [];  // ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ì €ì¥
let subscribedChannels = [];  // êµ¬ë…í•œ ì±„ë„ ëª©ë¡

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ
{% if results and not results.error %}
allVideos = {{ results|tojson|safe }};

// êµ¬ë…í•œ ì±„ë„ ëª©ë¡ ì¶”ì¶œ
subscribedChannels = allVideos
    .filter(v => v.is_subscribed)
    .map(v => v.channel_id)
    .filter((v, i, a) => a.indexOf(v) === i);  // ì¤‘ë³µ ì œê±°

// ì´ˆê¸° ë Œë”ë§
renderVideos(allVideos);
{% endif %}

// ============== í•„í„° ê¸°ëŠ¥ ==============
function toggleFilters() {
    const filters = document.getElementById('search-filters');
    filters.classList.toggle('show');
}

function resetFilters() {
    document.getElementById('filter-duration').value = '';
    document.getElementById('filter-upload-date').value = '';
    document.getElementById('filter-sort').value = 'relevance';
    document.getElementById('filter-channel').value = '';
    applyFilters();
}

function applyFilters() {
    const durationFilter = document.getElementById('filter-duration').value;
    const uploadDateFilter = document.getElementById('filter-upload-date').value;
    const sortFilter = document.getElementById('filter-sort').value;
    const channelFilter = document.getElementById('filter-channel').value;

    let filtered = [...allVideos];

    // 1. ê¸¸ì´ í•„í„°
    if (durationFilter) {
        filtered = filtered.filter(video => {
            const duration = video.duration || 0;
            if (durationFilter === 'short') return duration < 60;
            if (durationFilter === 'medium') return duration >= 300 && duration <= 1200;
            if (durationFilter === 'long') return duration > 1200;
            return true;
        });
    }

    // 2. ì—…ë¡œë“œ ë‚ ì§œ í•„í„° (upload_date ì •ë³´ê°€ ìˆë‹¤ë©´)
    // yt-dlpì˜ extract_flatì—ì„œëŠ” ë‚ ì§œ ì •ë³´ê°€ ì œí•œì ì´ë¯€ë¡œ ì´ ë¶€ë¶„ì€ ì œí•œì 
    // ì‹¤ì œë¡œëŠ” yt-dlp ê²€ìƒ‰ì—ì„œ ë‚ ì§œ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ì•¼ ì •í™•

    // 3. ì±„ë„ í•„í„°
    if (channelFilter === 'subscribed') {
        filtered = filtered.filter(video => video.is_subscribed);
    }

    // 4. ì •ë ¬
    if (sortFilter === 'views') {
        filtered.sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
    } else if (sortFilter === 'date') {
        // ìµœì‹ ìˆœ (upload_dateê°€ ìˆë‹¤ë©´)
        // extract_flatì—ì„œëŠ” ì •í™•í•œ ë‚ ì§œ ì •ë³´ê°€ ì—†ì„ ìˆ˜ ìˆìŒ
        filtered.reverse();  // ê°„ë‹¨íˆ ì—­ìˆœìœ¼ë¡œ
    }
    // relevanceëŠ” ê¸°ë³¸ ìˆœì„œ ìœ ì§€

    // ê²°ê³¼ ë Œë”ë§
    renderVideos(filtered);

    // í•„í„°ëœ ê°œìˆ˜ í‘œì‹œ
    const filteredCount = document.getElementById('filtered-count');
    if (filtered.length !== allVideos.length) {
        filteredCount.textContent = `(${filtered.length}ê°œ í‘œì‹œ)`;
    } else {
        filteredCount.textContent = '';
    }
}

function renderVideos(videos) {
    const container = document.getElementById('search-results');
    if (!container) return;

    container.innerHTML = '';

    if (videos.length === 0) {
        container.innerHTML = '<div class="no-results"><p>í•„í„° ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        return;
    }

    videos.forEach(video => {
        const item = createSearchItemElement(video);
        container.innerHTML += item;
    });

    document.getElementById('count-number').textContent = videos.length;
}

function createSearchItemElement(video) {
    const duration = video.duration ? formatDuration(video.duration) : '';
    const viewCount = video.view_count ? formatViews(video.view_count) : '';
    const isSubscribed = video.is_subscribed || false;

    return `
        <div class="search-item">
            <a href="/watch?v=${video.id}" class="search-link">
                <div class="thumbnail">
                    <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" loading="lazy">
                    ${duration ? `<span class="duration">${duration}</span>` : ''}
                </div>
                <div class="search-info">
                    <h3>${escapeHtml(video.title)}</h3>
                    <p class="channel">${escapeHtml(video.channel || '')}</p>
                    ${viewCount ? `<p class="views">ì¡°íšŒìˆ˜ ${viewCount}íšŒ</p>` : ''}
                </div>
            </a>
            <div class="search-actions">
                ${video.channel_id ? `
                <button class="action-btn subscribe-btn ${isSubscribed ? 'subscribed' : ''}"
                        onclick="toggleSubscribe(this, '${video.channel_id}', '${escapeHtml(video.channel)}')"
                        title="${isSubscribed ? 'êµ¬ë… ì·¨ì†Œ' : 'êµ¬ë…'}">
                    ${isSubscribed ? 'â˜…' : 'â˜†'}
                </button>
                ` : ''}
                <button class="action-btn"
                        onclick="openPlaylistModal(this)"
                        data-id="${video.id}"
                        data-title="${escapeHtml(video.title)}"
                        data-thumbnail="${video.thumbnail}"
                        data-duration="${video.duration || 0}"
                        data-channel="${escapeHtml(video.channel || '')}"
                        title="í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€">
                    â•
                </button>
            </div>
        </div>
    `;
}

// ============== í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê¸°ëŠ¥ ==============
function openPlaylistModal(btn) {
    currentVideoData = {
        id: btn.dataset.id,
        title: btn.dataset.title,
        thumbnail: btn.dataset.thumbnail,
        duration: parseFloat(btn.dataset.duration),
        channel: btn.dataset.channel
    };
    document.getElementById('playlist-modal').classList.add('show');
    document.getElementById('new-playlist-name').value = '';
}

function closePlaylistModal() {
    document.getElementById('playlist-modal').classList.remove('show');
    currentVideoData = null;
}

async function addToPlaylist(playlistId) {
    if (!currentVideoData) return;
    
    // APIê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const requestData = {
        video_id: currentVideoData.id,
        title: currentVideoData.title,
        thumbnail: currentVideoData.thumbnail,
        duration: currentVideoData.duration,
        channel: currentVideoData.channel
    };

    console.log('Adding to playlist:', playlistId, requestData);

    try {
        const response = await fetch('/api/playlist/' + playlistId + '/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        console.log('Response:', data);

        if (data.success) {
            showToast(data.message || 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            closePlaylistModal();
        } else {
            showToast(data.message || 'ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    } catch (e) {
        console.error('Error:', e);
        showToast('ì˜¤ë¥˜ ë°œìƒ');
    }
}

async function createAndAddPlaylist() {
    if (!currentVideoData) return;
    
    const nameInput = document.getElementById('new-playlist-name');
    const name = nameInput.value.trim();
    if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }
    
    try {
        const response = await fetch('/api/playlist/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        });
        
        const data = await response.json();
        if (data.playlist_id) {
            await addToPlaylist(data.playlist_id);
            location.reload(); // ëª©ë¡ ê°±ì‹ ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨
        }
    } catch (e) {
        showToast('ìƒì„± ì‹¤íŒ¨');
    }
}

async function toggleSubscribe(btn, channelId, channelName) {
    const isSubscribed = btn.classList.contains('subscribed');
    const channelUrl = `https://www.youtube.com/channel/${channelId}`;
    
    try {
        const endpoint = isSubscribed ? '/api/channel/unsubscribe' : '/api/channel/subscribe';
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                channel_id: channelId,
                name: channelName,
                channel_url: channelUrl
            })
        });
        
        if (response.ok) {
            btn.classList.toggle('subscribed');
            btn.innerHTML = isSubscribed ? 'â˜†' : 'â˜…';
            btn.title = isSubscribed ? 'êµ¬ë…' : 'êµ¬ë… ì·¨ì†Œ';
            showToast(isSubscribed ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€');
        }
    } catch (e) {
        showToast('ìš”ì²­ ì‹¤íŒ¨');
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
document.getElementById('playlist-modal').addEventListener('click', function(e) {
    if (e.target === this) closePlaylistModal();
});

document.getElementById('new-playlist-name').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') createAndAddPlaylist();
});

// ë”ë³´ê¸° ê¸°ëŠ¥
{% if results and results|length >= 20 %}
const searchQuery = '{{ query }}';
let currentOffset = {{ results|length }};
let isLoading = false;
let hasMore = true;

const loadMoreBtn = document.getElementById('load-more-btn');
const loadingSpinner = document.getElementById('loading-spinner');
const noMoreResults = document.getElementById('no-more-results');

// ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­
loadMoreBtn?.addEventListener('click', loadMoreResults);

// ìë™ ìŠ¤í¬ë¡¤ ë¡œë“œ (ì„ íƒì )
let scrollTimeout;
window.addEventListener('scroll', function() {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
        const scrollPosition = window.innerHeight + window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;

        // í˜ì´ì§€ í•˜ë‹¨ ê·¼ì²˜ì—ì„œ ìë™ ë¡œë“œ
        if (scrollPosition >= pageHeight - 500 && hasMore && !isLoading) {
            loadMoreResults();
        }
    }, 100);
});

async function loadMoreResults() {
    if (isLoading || !hasMore) return;

    isLoading = true;
    loadMoreBtn.style.display = 'none';
    loadingSpinner.style.display = 'block';

    try {
        console.log(`Loading more results for: ${searchQuery}, offset: ${currentOffset}`);
        const response = await fetch(`/api/search?q=${encodeURIComponent(searchQuery)}&offset=${currentOffset}&limit=20`);
        const data = await response.json();

        console.log('Search API response:', data);

        if (data.success && data.videos && data.videos.length > 0) {
            // ìƒˆ ì˜ìƒì„ allVideosì— ì¶”ê°€
            allVideos.push(...data.videos);

            currentOffset += data.videos.length;
            hasMore = data.has_more;

            // í•„í„° ë‹¤ì‹œ ì ìš©
            applyFilters();

            showToast(`${data.videos.length}ê°œì˜ ê²°ê³¼ë¥¼ ë” ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
        } else {
            hasMore = false;
            noMoreResults.style.display = 'block';
            showToast('ë” ì´ìƒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        console.error('Error loading more results:', error);
        showToast('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
        isLoading = false;
        loadingSpinner.style.display = 'none';

        if (hasMore) {
            loadMoreBtn.style.display = 'inline-block';
        } else {
            noMoreResults.style.display = 'block';
        }
    }
}
{% endif %}


// ============== í—¬í¼ í•¨ìˆ˜ ==============
function formatDuration(seconds) {
    if (!seconds) return '0:00';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

function formatViews(count) {
    if (!count) return '0';
    if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
    if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
    return count.toString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}
{% endif %}
</script>

<style>
.search-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.btn-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 0.5rem 1rem;
}

.btn-filter:hover {
    background-color: var(--bg-tertiary);
}

.search-filters {
    display: none;
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    gap: 1rem;
    flex-wrap: wrap;
}

.search-filters.show {
    display: flex;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 150px;
}

.filter-group label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.filter-group select {
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
    font-size: 0.875rem;
}

.btn-reset {
    align-self: flex-end;
    padding: 0.5rem 1rem;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border);
}

.btn-reset:hover {
    background-color: var(--border);
}

#filtered-count {
    color: var(--accent);
    font-size: 0.875rem;
}

.no-results, .search-placeholder {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.subscribe-btn {
    color: var(--text-secondary);
    font-size: 1.2rem;
}

.subscribe-btn.subscribed {
    color: #ffd700; /* Gold color for star */
}

.subscribe-btn:hover {
    color: var(--text-primary);
}

.subscribe-btn.subscribed:hover {
    color: #ffed4a;
}

.search-results-header {
    margin-bottom: 1rem;
}

.search-results-header p {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

#count-number {
    font-weight: 600;
    color: var(--text-primary);
}
</style>
{% endblock %}