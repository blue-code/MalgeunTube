{% extends 'base.html' %}

{% block title %}{{ video.title or 'Video' }} - MalgeunTube{% endblock %}

{% block content %}
<div class="watch-container">
    {% if video.error %}
    <div class="error-message">
        <h2>âš ï¸ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
        <p>{{ video.error }}</p>
        <a href="{{ url_for('index') }}" class="btn">í™ˆìœ¼ë¡œ</a>
    </div>
    {% else %}
    <div class="watch-layout">
        <div class="video-section">
            <div class="video-wrapper" id="video-wrapper">
                <video id="video-player" controls autoplay playsinline webkit-playsinline>
                    {% if video.formats %}
                    <source src="{{ video.formats[0].url }}" type="video/mp4">
                    {% endif %}
                </video>
                <div class="video-loading" id="video-loading">
                    <div class="spinner"></div>
                    <p>ë¡œë”©ì¤‘...</p>
                </div>
            </div>
            
            <div class="video-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>í™”ì§ˆ</label>
                        <select id="quality">
                            {% for format in video.formats %}
                            <option value="{{ format.url }}" data-height="{{ format.quality }}" {% if loop.first %}selected{% endif %}>
                                {{ format.resolution }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>ì†ë„</label>
                        <select id="speed">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                    
                    {% if playlist %}
                    <div class="control-group">
                        <label>ëª¨ë“œ</label>
                        <select id="play-mode">
                            <option value="normal">ìˆœì°¨</option>
                            <option value="shuffle">ì…”í”Œ</option>
                            <option value="repeat-one">ë°˜ë³µ</option>
                        </select>
                    </div>
                    {% endif %}
                </div>
                
                <button id="download-btn" class="btn btn-icon" title="ë‹¤ìš´ë¡œë“œ" onclick="openDownloadModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    <span>ë‹¤ìš´ë¡œë“œ</span>
                </button>
                
                <button id="add-to-playlist-btn" class="btn btn-icon">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    <span>ì €ì¥</span>
                </button>
            </div>
            
            <div class="video-details">
                <h1>{{ video.title }}</h1>
                <div class="video-meta">
                    <span>{{ video.view_count|views }}íšŒ</span>
                    {% if video.like_count %}
                    <span>ğŸ‘ {{ video.like_count|views }}</span>
                    {% endif %}
                </div>
                
                <div class="channel-info">
                    <a href="{{ url_for('channel_detail', channel_id=video.channel_id) }}" class="channel-link">
                        <div class="channel-avatar">{{ video.channel[0] if video.channel else '?' }}</div>
                        <span class="channel-name">{{ video.channel }}</span>
                    </a>
                    <button id="subscribe-btn" class="btn btn-subscribe {% if video.is_subscribed %}subscribed{% endif %}"
                            data-channel-id="{{ video.channel_id }}"
                            data-channel-name="{{ video.channel }}"
                            data-channel-url="{{ video.channel_url }}">
                        {% if video.is_subscribed %}âœ“ êµ¬ë…ì¤‘{% else %}â­ ì¦ê²¨ì°¾ê¸°{% endif %}
                    </button>
                </div>
                
                <div class="description collapsed" id="description">
                    <p>{{ video.description }}</p>
                </div>
                <button class="desc-toggle" id="desc-toggle">ë”ë³´ê¸°</button>
            </div>
        </div>
        
        <div class="sidebar">
            {% if playlist %}
            <div class="sidebar-section playlist-section">
                <div class="sidebar-header">
                    <h3>ğŸµ {{ playlist.title }}</h3>
                    <span class="video-count">{{ playlist.videos|length }}ê°œ</span>
                </div>
                <div class="playlist-items" id="playlist-items">
                    {% for pv in playlist.videos %}
                    <a href="{{ url_for('watch', v=pv.id, list=playlist.id, index=loop.index0) }}" 
                       class="playlist-item {% if pv.id == video.id %}active{% endif %}"
                       data-index="{{ loop.index0 }}">
                        <span class="playlist-index">{{ loop.index }}</span>
                        <div class="playlist-thumb">
                            <img src="{{ pv.thumbnail }}" alt="" loading="lazy">
                        </div>
                        <div class="playlist-info">
                            <p>{{ pv.title }}</p>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="sidebar-section">
                <h3>ğŸ¯ ì¶”ì²œ ì˜ìƒ</h3>
                <div class="related-videos">
                    {% for rv in related_videos %}
                    <a href="{{ url_for('watch', v=rv.id) }}" class="related-item">
                        <div class="related-thumb">
                            <img src="{{ rv.thumbnail }}" alt="" loading="lazy">
                            {% if rv.duration %}
                            <span class="duration">{{ rv.duration|duration }}</span>
                            {% endif %}
                        </div>
                        <div class="related-info">
                            <p class="related-title">{{ rv.title }}</p>
                            <span class="related-channel">{{ rv.channel }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div id="playlist-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</h3>
            <button class="modal-close" onclick="closePlaylistModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="playlist-list">
                {% for pl in user_playlists %}
                <button class="playlist-option" onclick="addToPlaylist('{{ pl.id }}')">
                    ğŸ“ {{ pl.name }} ({{ pl.videos|length }}ê°œ)
                </button>
                {% endfor %}
            </div>
            <div class="create-playlist">
                <input type="text" id="new-playlist-name" placeholder="ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„">
                <button onclick="createAndAddPlaylist()" class="btn">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<script>
var videoData = {
    id: '{{ video.id }}',
    title: '{{ video.title|e }}',
    thumbnail: '{{ video.thumbnail }}',
    duration: {{ video.duration or 0 }},
    channel: '{{ video.channel|e }}'
};

var playlistData = {{ playlist|tojson|safe if playlist else 'null' }};
var playlistIndex = {{ playlist_index }};

document.addEventListener('DOMContentLoaded', function() {
    var player = document.getElementById('video-player');
    var loading = document.getElementById('video-loading');
    var qualitySelect = document.getElementById('quality');
    var speedSelect = document.getElementById('speed');
    var playModeSelect = document.getElementById('play-mode');
    
    var description = document.getElementById('description');
    var descToggle = document.getElementById('desc-toggle');
    if (descToggle) {
        descToggle.addEventListener('click', function() {
            description.classList.toggle('collapsed');
            this.textContent = description.classList.contains('collapsed') ? 'ë”ë³´ê¸°' : 'ì ‘ê¸°';
        });
    }
    
    if (player) {
        player.addEventListener('loadstart', function() { loading.style.display = 'flex'; });
        player.addEventListener('canplay', function() { loading.style.display = 'none'; });
        player.addEventListener('error', function() {
            loading.innerHTML = '<p>âš ï¸ ì¬ìƒ ë¶ˆê°€</p>';
        });
        
        if (qualitySelect) {
            // Apply preferred quality
            var prefQuality = localStorage.getItem('preferredQuality') || 'best';
            var options = qualitySelect.options;
            var targetIndex = 0;

            if (prefQuality === 'worst') {
                targetIndex = options.length - 1;
            } else if (prefQuality !== 'best') {
                // Find closest resolution
                var targetHeight = parseInt(prefQuality);
                var minDiff = Infinity;
                
                for (var i = 0; i < options.length; i++) {
                    var height = parseInt(options[i].getAttribute('data-height')) || 0;
                    var diff = Math.abs(height - targetHeight);
                    if (diff < minDiff) {
                        minDiff = diff;
                        targetIndex = i;
                    }
                }
            }

            // If strictly matching 1080p/720p etc, we might want to prioritize equal or lower if bandwidth is concern, 
            // but "closest" is a good general strategy for now.
            
            if (targetIndex !== 0 && targetIndex < options.length) {
                qualitySelect.selectedIndex = targetIndex;
                player.src = qualitySelect.value;
                // Don't auto-play here, let the autoplay attribute or user interaction handle it
                // unless we want to ensure the quality switch doesn't stop autoplay.
                // Since <video autoplay> is present, changing src might require re-triggering play if it was playing.
                // But this runs on DOMContentLoaded, so video might be just starting.
            }

            qualitySelect.addEventListener('change', function() {
                var currentTime = player.currentTime;
                var wasPlaying = !player.paused;
                player.src = this.value;
                player.currentTime = currentTime;
                if (wasPlaying) player.play();
            });
        }
        
        if (speedSelect) {
            speedSelect.addEventListener('change', function() {
                player.playbackRate = parseFloat(this.value);
            });
        }
        
        player.addEventListener('ended', function() {
            if (playlistData && playlistData.videos) {
                var mode = playModeSelect ? playModeSelect.value : 'normal';
                var nextIndex;
                
                if (mode === 'repeat-one') {
                    player.currentTime = 0;
                    player.play();
                    return;
                } else if (mode === 'shuffle') {
                    nextIndex = Math.floor(Math.random() * playlistData.videos.length);
                } else {
                    nextIndex = playlistIndex + 1;
                    if (nextIndex >= playlistData.videos.length) {
                        showToast('ì¬ìƒ ì™„ë£Œ');
                        return;
                    }
                }
                
                var nextVideo = playlistData.videos[nextIndex];
                if (nextVideo) {
                    window.location.href = '/watch?v=' + nextVideo.id + '&list=' + playlistData.id + '&index=' + nextIndex;
                }
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key.toLowerCase()) {
                case ' ':
                case 'k':
                    e.preventDefault();
                    player.paused ? player.play() : player.pause();
                    break;
                case 'arrowleft':
                case 'j':
                    player.currentTime -= 5;
                    break;
                case 'arrowright':
                case 'l':
                    player.currentTime += 5;
                    break;
                case 'f':
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        player.requestFullscreen();
                    }
                    break;
                case 'm':
                    player.muted = !player.muted;
                    break;
            }
        });
    }
    
    var subscribeBtn = document.getElementById('subscribe-btn');
    if (subscribeBtn) {
        subscribeBtn.addEventListener('click', function() {
            var btn = this;
            var channelId = btn.dataset.channelId;
            var channelName = btn.dataset.channelName;
            var channelUrl = btn.dataset.channelUrl;
            var isSubscribed = btn.classList.contains('subscribed');
            
            var endpoint = isSubscribed ? '/api/channel/unsubscribe' : '/api/channel/subscribe';
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel_id: channelId, name: channelName, channel_url: channelUrl })
            }).then(function(response) {
                if (response.ok) {
                    btn.classList.toggle('subscribed');
                    btn.textContent = isSubscribed ? 'â­ ì¦ê²¨ì°¾ê¸°' : 'âœ“ êµ¬ë…ì¤‘';
                    showToast(isSubscribed ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€');
                }
            });
        });
    }
});

function openPlaylistModal() {
    document.getElementById('playlist-modal').classList.add('show');
}

function closePlaylistModal() {
    document.getElementById('playlist-modal').classList.remove('show');
}

var addBtn = document.getElementById('add-to-playlist-btn');
if (addBtn) {
    addBtn.addEventListener('click', openPlaylistModal);
}

function addToPlaylist(playlistId) {
    fetch('/api/playlist/' + playlistId + '/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(videoData)
    }).then(function(response) {
        if (response.ok) {
            showToast('ì¶”ê°€ ì™„ë£Œ');
            closePlaylistModal();
        } else {
            showToast('ì´ë¯¸ ì¶”ê°€ë¨');
        }
    });
}

function createAndAddPlaylist() {
    var name = document.getElementById('new-playlist-name').value.trim();
    if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }
    
    fetch('/api/playlist/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name })
    }).then(function(response) {
        return response.json();
    }).then(function(data) {
        if (data.playlist_id) {
            addToPlaylist(data.playlist_id);
        }
    });
}

var modal = document.getElementById('playlist-modal');
if (modal) {
    modal.addEventListener('click', function(e) {
        if (e.target === this) closePlaylistModal();
    });
}
<div id="download-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë‹¤ìš´ë¡œë“œ</h3>
            <button class="modal-close" onclick="closeDownloadModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('video')">ë¹„ë””ì˜¤</button>
                <button class="tab-btn" onclick="switchTab('audio')">ì˜¤ë””ì˜¤ (MP3)</button>
            </div>
            
            <div id="video-tab" class="tab-content active">
                <div class="control-group" style="margin-bottom: 1rem;">
                    <label>í•´ìƒë„ ì„ íƒ</label>
                    <select id="dl-video-quality" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                        <option value="best">ìµœê³  í™”ì§ˆ (Best)</option>
                        <option value="1080">1080p</option>
                        <option value="720">720p</option>
                        <option value="480">480p</option>
                    </select>
                </div>
                <button class="btn" onclick="requestDownload('video')" style="width: 100%;">ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            
            <div id="audio-tab" class="tab-content">
                <div class="control-group" style="margin-bottom: 1rem;">
                    <label>ìŒì§ˆ ì„ íƒ</label>
                    <select id="dl-audio-quality" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                        <option value="320">ê³ ìŒì§ˆ (320kbps)</option>
                        <option value="192" selected>ì¼ë°˜ (192kbps)</option>
                        <option value="128">ì €ìš©ëŸ‰ (128kbps)</option>
                    </select>
                </div>
                <button class="btn" onclick="requestDownload('audio')" style="width: 100%;">ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1rem;
}
.tab-btn {
    flex: 1;
    padding: 0.75rem;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
}
.tab-btn.active {
    color: var(--text-primary);
    border-bottom-color: var(--accent);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
</style>

<script>
function openDownloadModal() {
    document.getElementById('download-modal').classList.add('show');
}

function closeDownloadModal() {
    document.getElementById('download-modal').classList.remove('show');
}

function switchTab(type) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    if (type === 'video') {
        document.querySelector('.tab-btn:first-child').classList.add('active');
        document.getElementById('video-tab').classList.add('active');
    } else {
        document.querySelector('.tab-btn:last-child').classList.add('active');
        document.getElementById('audio-tab').classList.add('active');
    }
}

function requestDownload(type) {
    const videoId = videoData.id;
    let quality;
    
    if (type === 'video') {
        quality = document.getElementById('dl-video-quality').value;
    } else {
        quality = document.getElementById('dl-audio-quality').value;
    }
    
    fetch('/api/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            video_id: videoId,
            type: type,
            quality: quality
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.download_url) {
            showToast('ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ. ì‹œì‘í•©ë‹ˆë‹¤...');
            
            // Create hidden link and click it
            const link = document.createElement('a');
            link.href = data.download_url;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            closeDownloadModal();
        } else {
            showToast(data.message || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
        }
    })
    .catch(err => {
        showToast('ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    });
    
    showToast('ë‹¤ìš´ë¡œë“œë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
}

document.getElementById('download-modal').addEventListener('click', function(e) {
    if (e.target === this) closeDownloadModal();
});
</script>
{% endblock %}