{% extends 'base.html' %}

{% block title %}{{ video.title or 'Video' }} - MalgeunTube{% endblock %}

{% block content %}
<div class="watch-container">
    {% if video.error %}
    <div class="error-message">
        <h2>âš ï¸ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
        <p>{{ video.error }}</p>
        <a href="{{ url_for('index') }}" class="btn">í™ˆìœ¼ë¡œ</a>
    </div>
    {% else %}
    <div class="watch-layout">
        <div class="video-section">
            <div class="video-wrapper" id="video-wrapper">
                <video id="video-player" controls autoplay playsinline webkit-playsinline>
                    {% if video.formats %}
                    <source src="{{ video.formats[0].url }}" type="video/mp4">
                    {% endif %}
                </video>
                <div class="video-loading" id="video-loading">
                    <div class="spinner"></div>
                    <p>ë¡œë”©ì¤‘...</p>
                </div>
            </div>
            
            <div class="video-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>í™”ì§ˆ</label>
                        <select id="quality">
                            {% for format in video.formats %}
                            <option value="{{ format.url }}" data-height="{{ format.quality }}" {% if loop.first %}selected{% endif %}>
                                {{ format.resolution }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>ì†ë„</label>
                        <select id="speed">
                            <option value="0.25">0.25x</option>
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="1.75">1.75x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                    
                    {% if playlist %}
                    <div class="control-group">
                        <label>ëª¨ë“œ</label>
                        <select id="play-mode">
                            <option value="normal">ìˆœì°¨</option>
                            <option value="shuffle">ì…”í”Œ</option>
                            <option value="repeat-one">ë°˜ë³µ</option>
                        </select>
                    </div>
                    {% endif %}
                </div>
                
                <!-- PiP (Picture-in-Picture) ë²„íŠ¼ -->
                <button id="pip-btn" class="btn btn-icon" title="PiP ëª¨ë“œ" onclick="togglePiP()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M19 7h-8v6h8V7zm2-4H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
                    </svg>
                    <span>PiP</span>
                </button>
                
                <!-- í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ë„ì›€ë§ ë²„íŠ¼ -->
                <button class="btn btn-icon" title="ë‹¨ì¶•í‚¤ ë„ì›€ë§" onclick="document.getElementById('keyboard-help-modal').classList.add('show')">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/>
                    </svg>
                    <span>ë‹¨ì¶•í‚¤</span>
                </button>
                
                <button id="download-btn" class="btn btn-icon" title="ë‹¤ìš´ë¡œë“œ" onclick="openDownloadModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    <span>ë‹¤ìš´ë¡œë“œ</span>
                </button>
                
                <button id="add-to-playlist-btn" class="btn btn-icon">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    <span>ì €ì¥</span>
                </button>

                <button id="watch-later-btn" class="btn btn-icon" title="ë‚˜ì¤‘ì— ë³´ê¸°">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M14 10H2v2h12v-2zm0-4H2v2h12V6zm4 8v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM2 16h8v-2H2v2z"/></svg>
                    <span id="watch-later-text">ë‚˜ì¤‘ì—</span>
                </button>
            </div>
            
            <div class="video-details">
                <h1>{{ video.title }}</h1>
                <div class="video-meta">
                    <span>{{ video.view_count|views }}íšŒ</span>
                    {% if video.like_count %}
                    <span>ğŸ‘ {{ video.like_count|views }}</span>
                    {% endif %}
                </div>
                
                <div class="channel-info">
                    <a href="{{ url_for('channel_detail', channel_id=video.channel_id) }}" class="channel-link">
                        <div class="channel-avatar">{{ video.channel[0] if video.channel else '?' }}</div>
                        <span class="channel-name">{{ video.channel }}</span>
                    </a>
                    <button id="subscribe-btn" class="btn btn-subscribe {% if video.is_subscribed %}subscribed{% endif %}"
                            data-channel-id="{{ video.channel_id }}"
                            data-channel-name="{{ video.channel }}"
                            data-channel-url="{{ video.channel_url }}">
                        {% if video.is_subscribed %}âœ“ êµ¬ë…ì¤‘{% else %}â­ ì¦ê²¨ì°¾ê¸°{% endif %}
                    </button>
                </div>
                
                <div class="description collapsed" id="description">
                    <p>{{ video.description }}</p>
                </div>
                <button class="desc-toggle" id="desc-toggle">ë”ë³´ê¸°</button>
            </div>
        </div>
        
        <div class="sidebar">
            {% if playlist %}
            <div class="sidebar-section playlist-section">
                <div class="sidebar-header">
                    <h3>ğŸµ {{ playlist.title }}</h3>
                    <span class="video-count">{{ playlist.videos|length }}ê°œ</span>
                </div>
                <div class="playlist-items" id="playlist-items">
                    {% for pv in playlist.videos %}
                    <a href="{{ url_for('watch', v=pv.id, list=playlist.id, index=loop.index0) }}" 
                       class="playlist-item {% if pv.id == video.id %}active{% endif %}"
                       data-index="{{ loop.index0 }}">
                        <span class="playlist-index">{{ loop.index }}</span>
                        <div class="playlist-thumb">
                            <img src="{{ pv.thumbnail }}" alt="" loading="lazy">
                        </div>
                        <div class="playlist-info">
                            <p>{{ pv.title }}</p>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="sidebar-section">
                <h3>ğŸ¯ ì¶”ì²œ ì˜ìƒ</h3>
                <div class="related-videos">
                    {% for rv in related_videos %}
                    <a href="{{ url_for('watch', v=rv.id) }}" class="related-item">
                        <div class="related-thumb">
                            <img src="{{ rv.thumbnail }}" alt="" loading="lazy">
                            {% if rv.duration %}
                            <span class="duration">{{ rv.duration|duration }}</span>
                            {% endif %}
                        </div>
                        <div class="related-info">
                            <p class="related-title">{{ rv.title }}</p>
                            <span class="related-channel">{{ rv.channel }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div id="playlist-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</h3>
            <button class="modal-close" onclick="closePlaylistModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="playlist-list">
                {% for pl in user_playlists %}
                <button class="playlist-option" onclick="addToPlaylist('{{ pl.id }}')">
                    ğŸ“ {{ pl.name }} ({{ pl.videos|length }}ê°œ)
                </button>
                {% endfor %}
            </div>
            <div class="create-playlist">
                <input type="text" id="new-playlist-name" placeholder="ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„">
                <button onclick="createAndAddPlaylist()" class="btn">ìƒì„±</button>
            </div>
        </div>
    </div>
</div>

<div id="download-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ë‹¤ìš´ë¡œë“œ</h3>
            <button class="modal-close" onclick="closeDownloadModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('video')">ë¹„ë””ì˜¤</button>
                <button class="tab-btn" onclick="switchTab('audio')">ì˜¤ë””ì˜¤ (MP3)</button>
            </div>
            
            <div id="video-tab" class="tab-content active">
                <div class="control-group" style="margin-bottom: 1rem;">
                    <label>í•´ìƒë„ ì„ íƒ</label>
                    <select id="dl-video-quality" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                        <option value="best">ìµœê³  í™”ì§ˆ (Best)</option>
                        <option value="1080">1080p</option>
                        <option value="720">720p</option>
                        <option value="480">480p</option>
                    </select>
                </div>
                <button class="btn" onclick="requestDownload('video')" style="width: 100%;">ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            
            <div id="audio-tab" class="tab-content">
                <div class="control-group" style="margin-bottom: 1rem;">
                    <label>ìŒì§ˆ ì„ íƒ</label>
                    <select id="dl-audio-quality" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                        <option value="320">ê³ ìŒì§ˆ (320kbps)</option>
                        <option value="192" selected>ì¼ë°˜ (192kbps)</option>
                        <option value="128">ì €ìš©ëŸ‰ (128kbps)</option>
                    </select>
                </div>
                <button class="btn" onclick="requestDownload('audio')" style="width: 100%;">ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1rem;
}
.tab-btn {
    flex: 1;
    padding: 0.75rem;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
}
.tab-btn.active {
    color: var(--text-primary);
    border-bottom-color: var(--accent);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}

/* ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  ìŠ¤íƒ€ì¼ */
#download-progress-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.download-progress-modal {
    background-color: var(--bg-secondary);
    border-radius: 12px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.download-progress-content h3 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    text-align: center;
}

.progress-bar-container {
    width: 100%;
    height: 30px;
    background-color: var(--bg-tertiary);
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #4CAF50);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

#download-progress-text {
    font-weight: 600;
    color: var(--accent);
}

#download-speed {
    color: var(--text-secondary);
}

#download-status {
    text-align: center;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}
</style>

<script>
var videoData = {
    id: {{ video.id|tojson|safe }},
    title: {{ video.title|tojson|safe }},
    thumbnail: {{ video.thumbnail|tojson|safe }},
    duration: {{ (video.duration or 0)|tojson|safe }},
    channel: {{ video.channel|tojson|safe }}
};

var playlistData = {{ playlist|tojson|safe if playlist else 'null' }};
var playlistIndex = {{ playlist_index|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    var player = document.getElementById('video-player');
    var loading = document.getElementById('video-loading');
    var qualitySelect = document.getElementById('quality');
    var speedSelect = document.getElementById('speed');
    var playModeSelect = document.getElementById('play-mode');
    
    var description = document.getElementById('description');
    var descToggle = document.getElementById('desc-toggle');
    if (descToggle) {
        descToggle.addEventListener('click', function() {
            description.classList.toggle('collapsed');
            this.textContent = description.classList.contains('collapsed') ? 'ë”ë³´ê¸°' : 'ì ‘ê¸°';
        });
    }
    
    if (player) {
        player.addEventListener('loadstart', function() { loading.style.display = 'flex'; });
        player.addEventListener('canplay', function() { loading.style.display = 'none'; });
        player.addEventListener('error', function() {
            loading.innerHTML = '<p>âš ï¸ ì¬ìƒ ë¶ˆê°€</p>';
        });
        
        if (qualitySelect) {
            // Apply preferred quality
            var prefQuality = localStorage.getItem('preferredQuality') || 'best';
            var options = qualitySelect.options;
            var targetIndex = 0;

            if (prefQuality === 'worst') {
                targetIndex = options.length - 1;
            } else if (prefQuality !== 'best') {
                // Find closest resolution
                var targetHeight = parseInt(prefQuality);
                var minDiff = Infinity;
                
                for (var i = 0; i < options.length; i++) {
                    var height = parseInt(options[i].getAttribute('data-height')) || 0;
                    var diff = Math.abs(height - targetHeight);
                    if (diff < minDiff) {
                        minDiff = diff;
                        targetIndex = i;
                    }
                }
            }

            // If strictly matching 1080p/720p etc, we might want to prioritize equal or lower if bandwidth is concern, 
            // but "closest" is a good general strategy for now.
            
            if (targetIndex !== 0 && targetIndex < options.length) {
                qualitySelect.selectedIndex = targetIndex;
                player.src = qualitySelect.value;
                // Don't auto-play here, let the autoplay attribute or user interaction handle it
                // unless we want to ensure the quality switch doesn't stop autoplay.
                // Since <video autoplay> is present, changing src might require re-triggering play if it was playing.
                // But this runs on DOMContentLoaded, so video might be just starting.
            }

            qualitySelect.addEventListener('change', function() {
                var currentTime = player.currentTime;
                var wasPlaying = !player.paused;
                player.src = this.value;
                player.currentTime = currentTime;
                if (wasPlaying) player.play();
            });
        }
        
        if (speedSelect) {
            speedSelect.addEventListener('change', function() {
                player.playbackRate = parseFloat(this.value);
            });
        }
        
        player.addEventListener('ended', function() {
            if (playlistData && playlistData.videos) {
                var mode = playModeSelect ? playModeSelect.value : 'normal';
                var nextIndex;
                
                if (mode === 'repeat-one') {
                    player.currentTime = 0;
                    player.play();
                    return;
                } else if (mode === 'shuffle') {
                    nextIndex = Math.floor(Math.random() * playlistData.videos.length);
                } else {
                    nextIndex = playlistIndex + 1;
                    if (nextIndex >= playlistData.videos.length) {
                        showToast('ì¬ìƒ ì™„ë£Œ');
                        return;
                    }
                }
                
                var nextVideo = playlistData.videos[nextIndex];
                if (nextVideo) {
                    window.location.href = '/watch?v=' + nextVideo.id + '&list=' + playlistData.id + '&index=' + nextIndex;
                }
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key.toLowerCase()) {
                case ' ':
                case 'k':
                    e.preventDefault();
                    player.paused ? player.play() : player.pause();
                    break;
                case 'arrowleft':
                case 'j':
                    player.currentTime -= 5;
                    break;
                case 'arrowright':
                case 'l':
                    player.currentTime += 5;
                    break;
                case 'arrowup':
                    e.preventDefault();
                    player.volume = Math.min(1, player.volume + 0.1);
                    showToast('ë³¼ë¥¨: ' + Math.round(player.volume * 100) + '%');
                    break;
                case 'arrowdown':
                    e.preventDefault();
                    player.volume = Math.max(0, player.volume - 0.1);
                    showToast('ë³¼ë¥¨: ' + Math.round(player.volume * 100) + '%');
                    break;
                case 'f':
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        player.requestFullscreen();
                    }
                    break;
                case 'm':
                    player.muted = !player.muted;
                    showToast(player.muted ? 'ìŒì†Œê±°' : 'ìŒì†Œê±° í•´ì œ');
                    break;
                case 'p':
                    togglePiP();
                    break;
                case ',':
                case '<':
                    // ì¬ìƒ ì†ë„ ê°ì†Œ
                    var currentSpeedIndex = Array.from(speedSelect.options).findIndex(o => o.selected);
                    if (currentSpeedIndex > 0) {
                        speedSelect.selectedIndex = currentSpeedIndex - 1;
                        player.playbackRate = parseFloat(speedSelect.value);
                        showToast('ì†ë„: ' + speedSelect.value + 'x');
                    }
                    break;
                case '.':
                case '>':
                    // ì¬ìƒ ì†ë„ ì¦ê°€
                    var currentSpeedIndex = Array.from(speedSelect.options).findIndex(o => o.selected);
                    if (currentSpeedIndex < speedSelect.options.length - 1) {
                        speedSelect.selectedIndex = currentSpeedIndex + 1;
                        player.playbackRate = parseFloat(speedSelect.value);
                        showToast('ì†ë„: ' + speedSelect.value + 'x');
                    }
                    break;
                // ìˆ«ì í‚¤ë¡œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™ (0-9)
                case '0':
                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                case '9':
                    var percentage = parseInt(e.key) / 10;
                    player.currentTime = player.duration * percentage;
                    break;
            }
        });
    }
    
    var subscribeBtn = document.getElementById('subscribe-btn');
    if (subscribeBtn) {
        subscribeBtn.addEventListener('click', function() {
            var btn = this;
            var channelId = btn.dataset.channelId;
            var channelName = btn.dataset.channelName;
            var channelUrl = btn.dataset.channelUrl;
            var isSubscribed = btn.classList.contains('subscribed');
            
            var endpoint = isSubscribed ? '/api/channel/unsubscribe' : '/api/channel/subscribe';
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel_id: channelId, name: channelName, channel_url: channelUrl })
            }).then(function(response) {
                if (response.ok) {
                    btn.classList.toggle('subscribed');
                    btn.textContent = isSubscribed ? 'â­ ì¦ê²¨ì°¾ê¸°' : 'âœ“ êµ¬ë…ì¤‘';
                    showToast(isSubscribed ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€');
                }
            });
        });
    }
});

// Picture-in-Picture í† ê¸€
function togglePiP() {
    var player = document.getElementById('video-player');
    if (!player) return;
    
    if (document.pictureInPictureElement) {
        document.exitPictureInPicture()
            .then(function() {
                showToast('PiP ëª¨ë“œ ì¢…ë£Œ');
            })
            .catch(function(error) {
                console.error('PiP ì¢…ë£Œ ì‹¤íŒ¨:', error);
            });
    } else if (document.pictureInPictureEnabled) {
        player.requestPictureInPicture()
            .then(function() {
                showToast('PiP ëª¨ë“œ ì‹œì‘');
            })
            .catch(function(error) {
                console.error('PiP ì‹œì‘ ì‹¤íŒ¨:', error);
                showToast('PiPë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤');
            });
    } else {
        showToast('PiPë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤');
    }
}

function openPlaylistModal() {
    document.getElementById('playlist-modal').classList.add('show');
}

function closePlaylistModal() {
    document.getElementById('playlist-modal').classList.remove('show');
}

var addBtn = document.getElementById('add-to-playlist-btn');
if (addBtn) {
    addBtn.addEventListener('click', openPlaylistModal);
}

function addToPlaylist(playlistId) {
    console.log('Adding to playlist:', playlistId, videoData);

    // APIê°€ ê¸°ëŒ€í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const requestData = {
        video_id: videoData.id,
        title: videoData.title,
        thumbnail: videoData.thumbnail,
        duration: videoData.duration,
        channel: videoData.channel
    };

    console.log('Request data:', requestData);

    fetch('/api/playlist/' + playlistId + '/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        console.log('Add playlist response:', data);
        if (data.success) {
            showToast(data.message || 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            closePlaylistModal();
        } else {
            showToast(data.message || 'ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    })
    .catch(function(error) {
        console.error('Error adding to playlist:', error);
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    });
}

function createAndAddPlaylist() {
    var name = document.getElementById('new-playlist-name').value.trim();
    if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }
    
    fetch('/api/playlist/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name })
    }).then(function(response) {
        return response.json();
    }).then(function(data) {
        if (data.playlist_id) {
            addToPlaylist(data.playlist_id);
        }
    });
}

var modal = document.getElementById('playlist-modal');
if (modal) {
    modal.addEventListener('click', function(e) {
        if (e.target === this) closePlaylistModal();
    });
}

function openDownloadModal() {
    document.getElementById('download-modal').classList.add('show');
}

function closeDownloadModal() {
    document.getElementById('download-modal').classList.remove('show');
}

function switchTab(type) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    if (type === 'video') {
        document.querySelector('.tab-btn:first-child').classList.add('active');
        document.getElementById('video-tab').classList.add('active');
    } else {
        document.querySelector('.tab-btn:last-child').classList.add('active');
        document.getElementById('audio-tab').classList.add('active');
    }
}

function requestDownload(type) {
    const videoId = videoData.id;
    let quality;
    
    if (type === 'video') {
        quality = document.getElementById('dl-video-quality').value;
    } else {
        quality = document.getElementById('dl-audio-quality').value;
    }
    
    // ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  UI ìš”ì†Œ ìƒì„±
    const progressContainer = document.createElement('div');
    progressContainer.id = 'download-progress-container';
    progressContainer.innerHTML = `
        <div class="download-progress-modal">
            <div class="download-progress-content">
                <h3>ë‹¤ìš´ë¡œë“œ ì¤‘...</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="download-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <span id="download-progress-text">0%</span>
                    <span id="download-speed"></span>
                </div>
                <div id="download-status">ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘...</div>
                <button onclick="cancelDownload()" class="btn" style="margin-top: 1rem;">ì·¨ì†Œ</button>
            </div>
        </div>
    `;
    document.body.appendChild(progressContainer);

    fetch('/api/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            video_id: videoId,
            type: type,
            quality: quality
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.download_id) {
            // ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  í´ë§ ì‹œì‘
            currentDownloadId = data.download_id;
            checkDownloadProgress(data.download_id);
        } else {
            showToast(data.message || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
            removeProgressUI();
        }
    })
    .catch(err => {
        showToast('ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
        removeProgressUI();
    });

    closeDownloadModal();
}

let currentDownloadId = null;
let progressCheckInterval = null;

function checkDownloadProgress(downloadId) {
    progressCheckInterval = setInterval(() => {
        fetch(`/api/download/progress/${downloadId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    clearInterval(progressCheckInterval);
                    showToast('ë‹¤ìš´ë¡œë“œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    removeProgressUI();
                    return;
                }

                const progressBar = document.getElementById('download-progress-bar');
                const progressText = document.getElementById('download-progress-text');
                const downloadSpeed = document.getElementById('download-speed');
                const downloadStatus = document.getElementById('download-status');

                if (!progressBar) return;

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                progressBar.style.width = data.progress + '%';
                progressText.textContent = data.progress + '%';

                // ì†ë„ í‘œì‹œ
                if (data.speed) {
                    downloadSpeed.textContent = data.speed;
                }

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                if (data.status === 'starting') {
                    downloadStatus.textContent = 'ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘...';
                } else if (data.status === 'downloading') {
                    downloadStatus.textContent = 'ë‹¤ìš´ë¡œë“œ ì¤‘...';
                    if (data.eta) {
                        downloadStatus.textContent += ` (ë‚¨ì€ ì‹œê°„: ${data.eta})`;
                    }
                } else if (data.status === 'processing') {
                    downloadStatus.textContent = 'íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...';
                } else if (data.status === 'completed') {
                    clearInterval(progressCheckInterval);
                    downloadStatus.textContent = 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ì¤‘...';

                    // ë‹¤ìš´ë¡œë“œ ì‹œì‘
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = data.download_url;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
                        removeProgressUI();
                    }, 500);
                } else if (data.status === 'error') {
                    clearInterval(progressCheckInterval);
                    downloadStatus.textContent = 'ì˜¤ë¥˜: ' + (data.error || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
                    showToast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));

                    setTimeout(removeProgressUI, 3000);
                }
            })
            .catch(err => {
                clearInterval(progressCheckInterval);
                console.error('Error checking progress:', err);
                removeProgressUI();
            });
    }, 1000); // 1ì´ˆë§ˆë‹¤ ì²´í¬
}

function cancelDownload() {
    if (progressCheckInterval) {
        clearInterval(progressCheckInterval);
    }
    currentDownloadId = null;
    removeProgressUI();
    showToast('ë‹¤ìš´ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function removeProgressUI() {
    const container = document.getElementById('download-progress-container');
    if (container) {
        container.remove();
    }
}

document.getElementById('download-modal').addEventListener('click', function(e) {
    if (e.target === this) closeDownloadModal();
});

// ============== ë‚˜ì¤‘ì— ë³´ê¸° ê¸°ëŠ¥ ==============
const watchLaterBtn = document.getElementById('watch-later-btn');
const watchLaterText = document.getElementById('watch-later-text');

// í˜„ì¬ ìƒíƒœ í™•ì¸
fetch(`/api/watch-later/check/${videoData.id}`)
    .then(res => res.json())
    .then(data => {
        if (data.is_added) {
            watchLaterBtn.classList.add('added');
            watchLaterText.textContent = 'ì¶”ê°€ë¨';
        }
    });

watchLaterBtn?.addEventListener('click', async function() {
    const isAdded = this.classList.contains('added');

    try {
        const endpoint = isAdded ? '/api/watch-later/remove' : '/api/watch-later/add';
        const requestData = {
            video_id: videoData.id,
            title: videoData.title,
            thumbnail: videoData.thumbnail,
            duration: videoData.duration,
            channel: videoData.channel,
            channel_id: {{ video.channel_id|tojson|safe }}
        };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();
        if (data.success) {
            this.classList.toggle('added');
            watchLaterText.textContent = isAdded ? 'ë‚˜ì¤‘ì—' : 'ì¶”ê°€ë¨';
            showToast(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
});

// ============== ì‹œì²­ ì§„í–‰ë¥  ì €ì¥ ==============
const player = document.getElementById('video-player');
let progressSaveInterval;

// ì§„í–‰ë¥  ë¡œë“œ ë° ì´ì–´ë³´ê¸°
fetch(`/api/progress/${videoData.id}`)
    .then(res => res.json())
    .then(data => {
        if (data.progress && data.progress.current_time > 10) {
            const progress = data.progress;
            const percentage = Math.round(progress.percentage);

            // ì´ì–´ë³´ê¸° í™•ì¸
            if (confirm(`${percentage}% ì‹œì²­í•œ ì˜ìƒì…ë‹ˆë‹¤. ì´ì–´ì„œ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                player.currentTime = progress.current_time;
            }
        }
    });

// 5ì´ˆë§ˆë‹¤ ì§„í–‰ë¥  ì €ì¥
if (player) {
    player.addEventListener('play', function() {
        progressSaveInterval = setInterval(function() {
            if (!player.paused && player.currentTime > 0 && player.duration > 0) {
                fetch('/api/progress/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        video_id: videoData.id,
                        current_time: player.currentTime,
                        duration: player.duration
                    })
                });
            }
        }, 5000); // 5ì´ˆë§ˆë‹¤
    });

    player.addEventListener('pause', function() {
        if (progressSaveInterval) {
            clearInterval(progressSaveInterval);
        }
        // ì¼ì‹œì •ì§€ ì‹œì—ë„ ì €ì¥
        if (player.currentTime > 0 && player.duration > 0) {
            fetch('/api/progress/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    video_id: videoData.id,
                    current_time: player.currentTime,
                    duration: player.duration
                })
            });
        }
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œì—ë„ ì €ì¥
    window.addEventListener('beforeunload', function() {
        if (player.currentTime > 0 && player.duration > 0) {
            navigator.sendBeacon('/api/progress/update', JSON.stringify({
                video_id: videoData.id,
                current_time: player.currentTime,
                duration: player.duration
            }));
        }
    });
}
</script>

<style>
#watch-later-btn.added {
    background-color: var(--accent);
    color: white;
}
</style>
{% endblock %}