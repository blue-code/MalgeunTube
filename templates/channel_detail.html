{% extends 'base.html' %}

{% block title %}{{ channel.channel if channel else 'ì±„ë„' }} - MalgeunTube{% endblock %}

{% block content %}
<div class="channel-detail-container">
    {% if channel %}
    <div class="channel-banner">
        <div class="channel-profile">
            <div class="channel-avatar-large">{{ channel.channel[0] if channel.channel else '?' }}</div>
            <div class="channel-info">
                <h1>{{ channel.channel }}</h1>
            </div>
            <button id="subscribe-btn" class="btn btn-subscribe {% if channel.is_subscribed %}subscribed{% endif %}"
                    data-channel-id="{{ channel.channel_id }}"
                    data-channel-name="{{ channel.channel }}"
                    data-channel-url="https://www.youtube.com/channel/{{ channel.channel_id }}">
                {% if channel.is_subscribed %}âœ“ êµ¬ë…ì¤‘{% else %}â­ ì¦ê²¨ì°¾ê¸°{% endif %}
            </button>
        </div>
    </div>
    
    <div class="channel-videos-section">
        <h2>ğŸ“º ì˜ìƒ <span id="video-count">({{ channel.videos|length }}ê°œ)</span></h2>
        {% if channel.videos %}
        <div class="video-grid" id="video-grid">
            {% for video in channel.videos %}
            <a href="{{ url_for('watch', v=video.id) }}" class="video-card">
                <div class="thumbnail">
                    <img src="{{ video.thumbnail }}" alt="{{ video.title }}" loading="lazy">
                    {% if video.duration %}
                    <span class="duration">{{ video.duration|duration }}</span>
                    {% endif %}
                </div>
                <div class="video-info">
                    <h4>{{ video.title }}</h4>
                    {% if video.view_count %}
                    <p>{{ video.view_count|views }}íšŒ</p>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>

        <div id="load-more-container" style="text-align: center; margin-top: 2rem;">
            <button id="load-more-btn" class="btn" style="display: none;">
                ë” ë§ì€ ì˜ìƒ ë³´ê¸°
            </button>
            <div id="loading-spinner" style="display: none; padding: 2rem;">
                <div class="spinner"></div>
                <p>ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
        {% else %}
        <p class="no-videos">ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
        {% endif %}
    </div>
    
    {% elif error %}
    <div class="error-message">
        <h2>âš ï¸ ì±„ë„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
        <p>{{ error }}</p>
        <a href="{{ url_for('index') }}" class="btn">í™ˆìœ¼ë¡œ</a>
    </div>
    {% else %}
    <div class="error-message">
        <h2>âš ï¸ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
        <a href="{{ url_for('index') }}" class="btn">í™ˆìœ¼ë¡œ</a>
    </div>
    {% endif %}
</div>

<style>
.channel-detail-container {
    max-width: 1200px;
    margin: 0 auto;
}

.channel-banner {
    background-color: var(--bg-secondary);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.channel-profile {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.channel-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 600;
    flex-shrink: 0;
}

.channel-info {
    flex: 1;
    min-width: 0;
}

.channel-info h1 {
    font-size: 1.5rem;
    line-height: 1.3;
}

.channel-videos-section h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
}

.no-videos {
    color: var(--text-secondary);
    text-align: center;
    padding: 2rem;
}

@media (max-width: 768px) {
    .channel-profile {
        flex-direction: column;
        text-align: center;
    }
    
    .channel-avatar-large {
        width: 64px;
        height: 64px;
        font-size: 1.5rem;
    }
    
    .channel-info h1 {
        font-size: 1.25rem;
    }
    
    #subscribe-btn {
        width: 100%;
    }
}
</style>

<script>
document.getElementById('subscribe-btn')?.addEventListener('click', async function() {
    const channelId = this.dataset.channelId;
    const channelName = this.dataset.channelName;
    const channelUrl = this.dataset.channelUrl;
    const isSubscribed = this.classList.contains('subscribed');
    
    const endpoint = isSubscribed ? '/api/channel/unsubscribe' : '/api/channel/subscribe';
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            channel_id: channelId,
            name: channelName,
            channel_url: channelUrl
        })
    });
    
    if (response.ok) {
        this.classList.toggle('subscribed');
        this.textContent = isSubscribed ? 'â­ ì¦ê²¨ì°¾ê¸°' : 'âœ“ êµ¬ë…ì¤‘';
        showToast(isSubscribed ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€');
    }
});

// ë”ë³´ê¸° ê¸°ëŠ¥
{% if channel and channel.videos %}
const channelId = '{{ channel.channel_id }}';
let currentOffset = {{ channel.videos|length }};
let isLoading = false;
let hasMore = {{ channel.videos|length }} >= 50; // 50ê°œ ì´ìƒì´ë©´ ë” ìˆì„ ê°€ëŠ¥ì„±

const loadMoreBtn = document.getElementById('load-more-btn');
const loadingSpinner = document.getElementById('loading-spinner');
const videoGrid = document.getElementById('video-grid');
const videoCount = document.getElementById('video-count');

// ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
if (hasMore) {
    loadMoreBtn.style.display = 'inline-block';
}

// ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­
loadMoreBtn?.addEventListener('click', loadMoreVideos);

// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ë¡œ ìë™ ë¡œë“œ (ì„ íƒì )
let scrollTimeout;
window.addEventListener('scroll', function() {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
        const scrollPosition = window.innerHeight + window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;

        // í˜ì´ì§€ í•˜ë‹¨ ê·¼ì²˜ì—ì„œ ìë™ ë¡œë“œ
        if (scrollPosition >= pageHeight - 500 && hasMore && !isLoading) {
            loadMoreVideos();
        }
    }, 100);
});

async function loadMoreVideos() {
    if (isLoading || !hasMore) return;

    isLoading = true;
    loadMoreBtn.style.display = 'none';
    loadingSpinner.style.display = 'block';

    try {
        const response = await fetch(`/api/channel/${channelId}/videos?offset=${currentOffset}&limit=20`);
        const data = await response.json();

        if (data.success && data.videos && data.videos.length > 0) {
            // ì˜ìƒ ì¹´ë“œ ì¶”ê°€
            data.videos.forEach(video => {
                const videoCard = createVideoCard(video);
                videoGrid.insertAdjacentHTML('beforeend', videoCard);
            });

            currentOffset += data.videos.length;
            hasMore = data.has_more;

            // ì˜ìƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            videoCount.textContent = `(${currentOffset}ê°œ)`;

            showToast(`${data.videos.length}ê°œì˜ ì˜ìƒì„ ë” ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
        } else {
            hasMore = false;
            showToast('ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        console.error('Error loading more videos:', error);
        showToast('ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
        isLoading = false;
        loadingSpinner.style.display = 'none';

        if (hasMore) {
            loadMoreBtn.style.display = 'inline-block';
        }
    }
}

function createVideoCard(video) {
    const duration = video.duration ? formatDuration(video.duration) : '';
    const viewCount = video.view_count ? formatViews(video.view_count) : '';

    return `
        <a href="/watch?v=${video.id}" class="video-card">
            <div class="thumbnail">
                <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" loading="lazy">
                ${duration ? `<span class="duration">${duration}</span>` : ''}
            </div>
            <div class="video-info">
                <h4>${escapeHtml(video.title)}</h4>
                ${viewCount ? `<p>${viewCount}íšŒ</p>` : ''}
            </div>
        </a>
    `;
}

function formatDuration(seconds) {
    if (!seconds) return '0:00';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

function formatViews(count) {
    if (!count) return '0';
    if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
    if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
    return count.toString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
{% endif %}
</script>
{% endblock %}