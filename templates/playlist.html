{% extends 'base.html' %}

{% block title %}{{ playlist.title if playlist else 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸' }} - MalgeunTube{% endblock %}

{% block content %}
<div class="playlist-container">
    {% if playlist and playlist.videos %}
    <div class="playlist-header-section">
        <div class="playlist-cover-large">
            {% if playlist.videos|length > 0 %}
            <img src="{{ playlist.videos[0].thumbnail }}" alt="">
            {% endif %}
            <div class="playlist-overlay">
                <span>{{ playlist.videos|length }}ê°œ ì˜ìƒ</span>
            </div>
        </div>
        <div class="playlist-header-info">
            <h1>{{ playlist.title }}</h1>
            {% if playlist.channel %}
            <p class="playlist-channel">{{ playlist.channel }}</p>
            {% endif %}
            {% if playlist.description %}
            <p class="playlist-desc">{{ playlist.description[:200] }}</p>
            {% endif %}
            <div class="playlist-actions">
                <a href="{{ url_for('watch', v=playlist.videos[0].id, list=playlist.id, index=0) }}" class="btn">
                    â–¶ ì „ì²´ ì¬ìƒ
                </a>
                {% if playlist.is_custom %}
                <button class="btn btn-danger" onclick="deletePlaylist('{{ playlist.id }}')">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="playlist-videos" id="playlist-videos">
        {% for video in playlist.videos %}
        <div class="playlist-video-item" data-video-id="{{ video.id }}" draggable="{% if playlist.is_custom %}true{% else %}false{% endif %}">
            <span class="video-index">{{ loop.index }}</span>

            {% if playlist.is_custom %}
            <div class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ì´ë™">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
            </div>
            {% endif %}

            <a href="{{ url_for('watch', v=video.id, list=playlist.id, index=loop.index0) }}" class="playlist-video-link">
                <div class="playlist-video-thumb">
                    <img src="{{ video.thumbnail }}" alt="" loading="lazy">
                    {% if video.duration %}
                    <span class="duration">{{ video.duration|duration }}</span>
                    {% endif %}
                </div>
                <div class="playlist-video-info">
                    <h4>{{ video.title }}</h4>
                    {% if video.channel %}
                    <p>{{ video.channel }}</p>
                    {% endif %}
                </div>
            </a>

            {% if playlist.is_custom %}
            <div class="video-controls">
                <button class="control-btn" onclick="moveVideo('{{ playlist.id }}', '{{ video.id }}', 'top')" title="ë§¨ ìœ„ë¡œ">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
                        <path d="M7 19h10v2H7z"/>
                    </svg>
                </button>
                <button class="control-btn" onclick="moveVideo('{{ playlist.id }}', '{{ video.id }}', 'up')" title="ìœ„ë¡œ">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
                    </svg>
                </button>
                <button class="control-btn" onclick="moveVideo('{{ playlist.id }}', '{{ video.id }}', 'down')" title="ì•„ë˜ë¡œ">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </button>
                <button class="control-btn" onclick="moveVideo('{{ playlist.id }}', '{{ video.id }}', 'bottom')" title="ë§¨ ì•„ë˜ë¡œ">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                        <path d="M7 3h10v2H7z"/>
                    </svg>
                </button>
                <button class="remove-btn" onclick="removeFromPlaylist('{{ playlist.id }}', '{{ video.id }}')" title="ì œê±°">
                    âœ•
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    {% elif playlist and playlist.error %}
    <div class="error-message">
        <h2>âš ï¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
        <p>{{ playlist.error }}</p>
        <a href="{{ url_for('index') }}" class="btn">í™ˆìœ¼ë¡œ</a>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“</div>
        <h3>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</h3>
        <p>ì˜ìƒì„ ì¶”ê°€í•´ë³´ì„¸ìš”</p>
        <a href="{{ url_for('index') }}" class="btn">í™ˆìœ¼ë¡œ</a>
    </div>
    {% endif %}
</div>

<style>
.playlist-container {
    max-width: 1000px;
    margin: 0 auto;
}

.playlist-header-section {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background-color: var(--bg-secondary);
    border-radius: 12px;
}

.playlist-cover-large {
    width: 280px;
    aspect-ratio: 16/9;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    flex-shrink: 0;
}

.playlist-cover-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.playlist-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    color: white;
    font-size: 0.875rem;
    text-align: center;
}

.playlist-header-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.playlist-header-info h1 {
    font-size: 1.5rem;
    line-height: 1.3;
}

.playlist-channel {
    color: var(--text-secondary);
}

.playlist-desc {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.5;
}

.playlist-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: auto;
}

.playlist-videos {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.playlist-video-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background-color: var(--bg-secondary);
    border-radius: 8px;
    transition: background-color 0.2s;
}

.playlist-video-item:hover {
    background-color: var(--bg-tertiary);
}

.video-index {
    width: 24px;
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.playlist-video-link {
    display: flex;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.playlist-video-thumb {
    width: 160px;
    aspect-ratio: 16/9;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    flex-shrink: 0;
}

.playlist-video-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.playlist-video-info {
    flex: 1;
    min-width: 0;
}

.playlist-video-info h4 {
    font-size: 0.9375rem;
    font-weight: 500;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 0.25rem;
}

.playlist-video-info p {
    color: var(--text-secondary);
    font-size: 0.8125rem;
}

/* ë“œë˜ê·¸ í•¸ë“¤ */
.drag-handle {
    cursor: move;
    padding: 0.5rem;
    color: var(--text-secondary);
    opacity: 0.5;
    transition: opacity 0.2s;
}

.drag-handle:hover {
    opacity: 1;
}

.playlist-video-item.dragging {
    opacity: 0.5;
    background-color: var(--accent);
}

.playlist-video-item.drag-over {
    border-top: 2px solid var(--accent);
}

/* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ */
.video-controls {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    opacity: 0;
    transition: opacity 0.2s;
}

.playlist-video-item:hover .video-controls {
    opacity: 1;
}

.control-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background-color 0.2s, color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.control-btn:hover {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
}

.remove-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1rem;
    cursor: pointer;
    padding: 0.5rem;
    opacity: 0.5;
    transition: opacity 0.2s, color 0.2s;
}

.remove-btn:hover {
    opacity: 1;
    color: #ff4444;
}

@media (max-width: 768px) {
    .playlist-header-section {
        flex-direction: column;
    }
    
    .playlist-cover-large {
        width: 100%;
    }
    
    .playlist-video-thumb {
        width: 120px;
    }
    
    .playlist-video-info h4 {
        font-size: 0.875rem;
    }
}
</style>

<script>
async function deletePlaylist(playlistId) {
    if (confirm('ì •ë§ ì´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const response = await fetch('/api/playlist/' + playlistId + '/delete', {
            method: 'POST'
        });
        if (response.ok) {
            window.location.href = '/playlists';
        }
    }
}

async function removeFromPlaylist(playlistId, videoId) {
    const response = await fetch('/api/playlist/' + playlistId + '/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ video_id: videoId })
    });
    if (response.ok) {
        location.reload();
    }
}

// ============== ì´ë™ ë²„íŠ¼ ê¸°ëŠ¥ ==============
async function moveVideo(playlistId, videoId, direction) {
    try {
        const response = await fetch(`/api/playlist/${playlistId}/move`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                video_id: videoId,
                direction: direction
            })
        });

        const data = await response.json();
        if (data.success) {
            showToast(data.message);
            location.reload();
        }
    } catch (error) {
        console.error('Error moving video:', error);
        showToast('ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

// ============== ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ==============
{% if playlist and playlist.is_custom %}
const playlistContainer = document.getElementById('playlist-videos');
let draggedElement = null;

// ëª¨ë“  ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì•„ì´í…œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
document.querySelectorAll('.playlist-video-item[draggable="true"]').forEach(item => {
    item.addEventListener('dragstart', handleDragStart);
    item.addEventListener('dragend', handleDragEnd);
    item.addEventListener('dragover', handleDragOver);
    item.addEventListener('drop', handleDrop);
    item.addEventListener('dragleave', handleDragLeave);
});

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');

    // ëª¨ë“  ë“œë˜ê·¸ ì˜¤ë²„ íš¨ê³¼ ì œê±°
    document.querySelectorAll('.playlist-video-item').forEach(item => {
        item.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    if (draggedElement !== this) {
        // ë“œë˜ê·¸ëœ ìš”ì†Œë¥¼ ë“œë¡­ ìœ„ì¹˜ë¡œ ì´ë™
        const allItems = [...playlistContainer.querySelectorAll('.playlist-video-item')];
        const draggedIndex = allItems.indexOf(draggedElement);
        const targetIndex = allItems.indexOf(this);

        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }

        // ìˆœì„œ ë³€ê²½ ì‚¬í•­ ì €ì¥
        savePlaylistOrder();
    }

    this.classList.remove('drag-over');
    return false;
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

// ë“œë˜ê·¸ ì˜¤ë²„ ì‹œê° íš¨ê³¼
document.querySelectorAll('.playlist-video-item[draggable="true"]').forEach(item => {
    item.addEventListener('dragenter', function(e) {
        if (draggedElement !== this) {
            this.classList.add('drag-over');
        }
    });
});

// ìˆœì„œ ì €ì¥
async function savePlaylistOrder() {
    const playlistId = '{{ playlist.id }}';
    const items = playlistContainer.querySelectorAll('.playlist-video-item');
    const videoIds = Array.from(items).map(item => item.dataset.videoId);

    try {
        const response = await fetch(`/api/playlist/${playlistId}/reorder`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_ids: videoIds })
        });

        const data = await response.json();
        if (data.success) {
            showToast(data.message);
            // ì¸ë±ìŠ¤ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            updateIndexNumbers();
        }
    } catch (error) {
        console.error('Error saving order:', error);
        showToast('ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

// ì¸ë±ìŠ¤ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
function updateIndexNumbers() {
    const items = playlistContainer.querySelectorAll('.playlist-video-item');
    items.forEach((item, index) => {
        const indexSpan = item.querySelector('.video-index');
        if (indexSpan) {
            indexSpan.textContent = index + 1;
        }
    });
}
{% endif %}
</script>
{% endblock %}